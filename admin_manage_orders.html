<!DOCTYPE html>
<html>
<head>
  <title>Manage Orders</title>
  <link rel="stylesheet" href="/css/bootstrap.min.css">
</head>
<body>
  <!--#include virtual="navbar.html" -->
  <div class="container">
    <h1 class="mb-4">Manage Orders</h1>
    <div id="orders-table">
      <!-- Orders table loads here -->
    </div>
  </div>
  <script src="/js/bootstrap.bundle.min.js"></script>
  <script>
    // JS for fetching orders and handling status/refunds
    document.addEventListener('DOMContentLoaded', function() {
  fetchOrders();

  function fetchOrders() {
    fetch('/admin_orders/list.php')
      .then(res => res.json())
      .then(data => renderOrders(data))
      .catch(() => {
        document.getElementById('orders-table').innerHTML = '<div class="alert alert-danger">Error loading orders.</div>';
      });
  }

  function renderOrders(orders) {
    let html = `
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Buyer</th>
            <th>Product</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${orders.map(order => `
            <tr>
              <td>${order.id}</td>
              <td>${order.buyer_name || order.buyer_id}</td>
              <td>${order.product_name || order.product_id}</td>
              <td>${order.amount}</td>
              <td>
                <select onchange="updateOrderStatus(${order.id}, this.value)" class="form-select form-select-sm" ${order.status === 'refunded' ? 'disabled' : ''}>
                  <option value="pending" ${order.status === 'pending' ? 'selected' : ''}>Pending</option>
                  <option value="shipped" ${order.status === 'shipped' ? 'selected' : ''}>Shipped</option>
                  <option value="completed" ${order.status === 'completed' ? 'selected' : ''}>Completed</option>
                  <option value="refunded" ${order.status === 'refunded' ? 'selected' : ''}>Refunded</option>
                </select>
              </td>
              <td>${order.created_at || ''}</td>
              <td>
                <button class="btn btn-warning btn-sm" onclick="refundOrder(${order.id})" ${order.status === 'refunded' ? 'disabled' : ''}>Refund</button>
              </td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    document.getElementById('orders-table').innerHTML = html;
  }

  window.updateOrderStatus = function(orderId, status) {
    fetch('/admin_orders/update.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `id=${encodeURIComponent(orderId)}&status=${encodeURIComponent(status)}`
    })
    .then(res => res.json())
    .then(() => fetchOrders());
  };

  window.refundOrder = function(orderId) {
    if(!confirm("Are you sure you want to refund this order?")) return;
    fetch('/admin_orders/refund.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
      body: `id=${encodeURIComponent(orderId)}`
    })
    .then(res => res.json())
    .then(() => fetchOrders());
  };
});
  </script>
</body>
</html>
